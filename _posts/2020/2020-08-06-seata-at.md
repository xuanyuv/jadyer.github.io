---
layout: post
title: "分布式事务02之Seata-AT模式"
categories: 分布式
tags: 分布式
author: 玄玉
excerpt: 介绍分布式事务框架Seata中的AT模式的原理。
published: true
---

* content
{:toc}


## 简述

它一种无侵入的分布式事务解决方案，属于 2PC 的广义实现，其源自阿里云 GTS 的 AT 模式的开源版

其核心价值在于

* 低成本：编程模型不变（原来怎么写还怎么写），轻依赖，不需要为分布式事务场景做特定设计（没有各种补偿）
* 高性能：一阶段提交（本地提交，全局没提交），不阻塞，连接释放，保证整个系统的吞吐<br>
　　　　　　注：这是比较难的地方，要想保证隔离性，就不能本地提交，这样性能就有衰减
　　　　　　　　虽然 XA 能保证隔离性，但是在没提交的情况下，资源都是被它锁住的，自然性能就不行
* 高可用：极端的异常情况下，可以暂停或跳过异常事务，保证系统可用
　　　　　　注：这就是一个柔性的问题了。比如说微服务设计时，也讲柔性，叫柔性可用
　　　　　　　　最常见的例子就是熔断降级，很多请求实在处理不了了，可以把它丢弃掉，要保证系统的整体可用

## 核心设计

* 一阶段：
1. 拦截业务SQL（可以认为RM把DataSource封装起来了）
2. 生成前镜像（然后再去执行SQL：相当于先备份数据，再执行SQL）
3. 生成后镜像（执行完SQL之后，再备份一下数据，因为分支事务SQL执行完是会本地提交的）
* 二阶段：TC 向所有 RM 发起提交或回滚

注：如果没有前镜像，那后面回滚时，就需要业务来做补偿，就做不到无侵入了

并且有了补偿就一定要考虑补偿的幂等（并且不是所有的业务都支持补偿时候的幂等），还有空补偿、资源悬挂等等问题



==【未完待续】==